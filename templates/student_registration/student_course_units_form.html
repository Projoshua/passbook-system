
<!-- templates/student_registration/student_course_units_list.html -->
{% extends 'student_registration/base.html' %}

{% block title %}Course Units - {{ access_number.access_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Manage Course Units</h2>
  <p><strong>Student:</strong> {{ access_number.student.get_full_name }}</p>
  <p><strong>Access Number:</strong> {{ access_number.access_number }}</p>

  <!-- Success/Error Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Registered Course Units Table -->
  <h4>Registered Course Units</h4>
  {% if course_units %}
  <table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>Code</th>
        <th>Title</th>
        <th>Status</th>
        <th>HOD Certified</th>
        <th>HOD Name</th>
        <th>Department</th>
        <th>Date</th>
        <th>Signature</th>
      </tr>
    </thead>
    <tbody>
      {% for cu in course_units %}
      <tr>
        <td>{{ cu.course_unit.code }}</td>
        <td>{{ cu.course_unit.title }}</td>
        <td>{{ cu.get_status_display }}</td>
        <td class="text-center">{% if cu.hod_certified %}✅{% else %}❌{% endif %}</td>
        <td>{{ cu.hod_name }}</td>
        <td>{{ cu.hod_department }}</td>
        <td>{{ cu.hod_certification_date|date:"Y-m-d" }}</td>
        <td>
          {% if cu.hod_signature %}
            <a href="{{ cu.hod_signature.url }}" target="_blank">
              <img src="{{ cu.hod_signature.url }}" alt="Signature" width="60" class="img-thumbnail">
            </a>
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p class="text-muted">No course units registered yet.</p>
  {% endif %}

  <hr>

  <!-- Bulk Add Formset -->
  <h4>Add New Course Units</h4>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>Course Unit</th>
          <th>Status</th>
          <th>HOD Certified?</th>
          <th>HOD Name</th>
          <th>Designation</th>
          <th>Department</th>
          <th>Certification Date</th>
          <th>Signature</th>
          <th>Remove?</th>
        </tr>
      </thead>
      <tbody>
        {{ formset.management_form }}
        {% for form in formset %}
        <tr>
          {% for field in form.visible_fields %}
          <td>
            {{ field }}
            {% if field.errors %}
              <div class="text-danger small mt-1">{{ field.errors }}</div>
            {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="submit" class="btn btn-primary">Save New Course Units</button>
  </form>
</div>

<!-- Optional: Add some inline JS to disable duplicate selections dynamically -->
<script>
  // Optional: Prevent selecting same course unit multiple times in formset
  document.addEventListener("change", function (e) {
    const selects = document.querySelectorAll("select[name$='course_unit']");
    const selectedValues = [];

    selects.forEach(select => {
      select.addEventListener("change", function () {
        // Reset all options
        selects.forEach(s => {
          Array.from(s.options).forEach(opt => {
            opt.disabled = false;
          });
        });

        // Collect selected values
        selects.forEach(s => {
          if (s.value) selectedValues.push(s.value);
        });

        // Disable already selected options in other dropdowns
        selects.forEach(s => {
          Array.from(s.options).forEach(opt => {
            if (opt.value && selectedValues.includes(opt.value) && opt.value !== s.value) {
              opt.disabled = true;
            }
          });
        });
      });
    });

    // Trigger on load
    selects[0].dispatchEvent(new Event('change'));
  });
</script>

{% endblock %}


