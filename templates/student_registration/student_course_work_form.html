
<!-- templates/student_registration/student_course_work_form.html -->
{% extends 'student_registration/base.html' %}

{% block title %}Manage Course Works - {{ access_num.access_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Student Info -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h3>Course Work Submission - {{ student.name }}</h3>
      <p class="text-muted">
        <strong>Access:</strong> {{ access_num.access_number }} |
        <strong>Programme:</strong> {{ student.programme }} |
        <strong>Term:</strong> {{ access_num.semester }} {{ access_num.academic_year }}
      </p>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Registered Course Works (Read-Only Table) -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Assigned Course Works</h5>
      <span class="badge bg-secondary">{{ access_num.course_works.count }}</span>
    </div>
    <div class="card-body p-0">
      {% if access_num.course_works.exists %}
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th width="20%">Course Unit</th>
                <th width="25%">Course Work</th>
                <th width="10%">Status</th>
                <th width="10%">Submitted</th>
                <th width="15%">HOD Certified?</th>
                <th width="10%">Signature</th>
              </tr>
            </thead>
            <!-- templates/student_registration/student_course_work_form.html -->
...
            <tbody>
  {% for cw in course_works %}
    <tr>
      <td>
        <code>{{ cw.course_work.course_unit.code }}</code>
      </td>
      <td>{{ cw.course_work.title }}</td>
      <td>
        <span class="badge 
          {% if cw.status == 'DONE' %}bg-success
          {% elif cw.status == 'MISSED' %}bg-danger
          {% else %}bg-secondary{% endif %}">
          {{ cw.get_status_display }}
        </span>
      </td>
      <td>{{ cw.submission_date|default:"—" }}</td>
      <td>
        {% if cw.hod_certified %}
          ✅ {{ cw.hod_name|truncatechars:15 }}
        {% else %}
          ❌
        {% endif %}
      </td>
      <td>
        {% if cw.hod_signature %}
          <a href="{{ cw.hod_signature.url }}" target="_blank">
            <img src="{{ cw.hod_signature.url }}" alt="Sig" width="40" class="rounded border">
          </a>
        {% else %}
          —
        {% endif %}
      </td>
    </tr>
  {% empty %}
    <tr>
      <td colspan="6" class="text-center text-muted">No course works assigned yet.</td>
    </tr>
  {% endfor %}
            </tbody>
           
          </table>
        </div>
      {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-journal-text display-4 opacity-50"></i>
          <p class="mt-3 fs-5">No course works assigned yet.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Bulk Add New Course Works -->
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ formset.management_form }}
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add New Course Works (Max 5)</h5>
      </div>
      <div class="card-body">
        <p class="text-muted small mb-3">
          Select up to 5 new course works from the student's registered course units.
        </p>

        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th width="20%">Course Work</th>
                <th width="12%">Status</th>
                <th width="10%">Submitted</th>
                <th width="10%">Certified?</th>
                <th width="14%">HOD Name</th>
                <th width="14%">Department</th>
                <th width="10%">Cert. Date</th>
                <th width="10%">Signature</th>
                <th width="8%">Remove?</th>
              </tr>
            </thead>
            <tbody>
              {{ formset.management_form }}
              {% for form in formset %}
                <tr>
                  {% for field in form.visible_fields %}
                    <td>
                      {{ field }}
                      {% if field.errors %}
                        <div class="text-danger small mt-1">{{ field.errors|join:", " }}</div>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Debug: Show if no course works available -->
        {% if formset.forms %}
          {% with formset.forms.0 as first_form %}
            {% if not first_form.course_work.field.queryset %}
              <div class="alert alert-info mt-2">
                <i class="bi bi-info-circle"></i>
                No unassigned course works available. All eligible course works are already assigned.
              </div>
            {% endif %}
          {% endwith %}
        {% endif %}
      </div>
    </div>
    <!-- Add this after the formset table -->
{% if not formset.forms %}
  <div class="alert alert-danger">Formset has no forms!</div>
{% endif %}

{% for form in formset %}
  {% if forloop.first %}
    <div class="alert alert-info small">
      Debug: This form has {{ form.course_work.field.queryset.count }} course works available.
      {% if not form.course_work.field.queryset %}
        All eligible course works are already assigned.
      {% endif %}
    </div>
  {% endif %}
{% endfor %}

    <!-- Action Buttons -->
    <div class="d-flex gap-2 mt-3">
      <button type="submit" class="btn btn-primary px-4">
        <i class="bi bi-save"></i> Save New Course Works
      </button>
      <a href="{% url 'pass_book:course_work_detail' access_number=access_num.access_number %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back
      </a>
    </div>
  </form>
</div>

<!-- Prevent Duplicate Selection in Dropdowns -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const selects = document.querySelectorAll("select[name$='course_work']");

    const updateOptions = () => {
      selects.forEach(s => {
        Array.from(s.options).forEach(opt => {
          opt.disabled = false;
        });
      });

      const selected = Array.from(selects).map(s => s.value).filter(v => v);

      selects.forEach(s => {
        Array.from(s.options).forEach(opt => {
          if (opt.value && selected.includes(opt.value) && opt.value !== s.value) {
            opt.disabled = true;
          }
        });
      });
    };

    selects.forEach(s => s.addEventListener("change", updateOptions));
    updateOptions();
  });
</script>

{% endblock %}


