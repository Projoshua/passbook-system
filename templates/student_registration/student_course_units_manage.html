<!-- templates/student_registration/student_course_units_manage.html -->
{% extends 'student_registration/base.html' %}

{% block title %}Manage Course Units - {{ access_number.access_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Student & Access Info -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h4 class="mb-0"><i class="fas fa-book-open me-2"></i>Course Unit Registration</h4>
      {% if access_number.id %}
      <div class="btn-group">
        <a href="{% url 'pass_book:student_course_units_list' access_number.id %}" class="btn btn-sm btn-light">
          <i class="fas fa-list"></i> List View
        </a>
        <a href="{% url 'pass_book:student_course_units_bulk' access_number.id %}" class="btn btn-sm btn-warning">
          <i class="fas fa-layer-group"></i> Bulk Add
        </a>
        <a href="{% url 'pass_book:student_course_unit_add' access_number.id %}" class="btn btn-sm btn-success">
          <i class="fas fa-plus-circle"></i> Single Add
        </a>
      </div>
      {% endif %}
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="d-flex align-items-center mb-2">
            <i class="fas fa-user-graduate text-primary me-2"></i>
            <div>
              <h6 class="mb-0">{{ access_number.student.name }}</h6>
              <small class="text-muted">Student</small>
            </div>
          </div>
          <p><strong><i class="fas fa-id-card me-2"></i>Reg No:</strong> {{ access_number.student.registration_number }}</p>
          <p><strong><i class="fas fa-graduation-cap me-2"></i>Programme:</strong> {{ access_number.student.programme }}</p>
        </div>
        <div class="col-md-6">
          <div class="card bg-light">
            <div class="card-body text-center">
              <p class="mb-1"><strong>Semester Code</strong></p>
              <h3 class="text-primary mb-2"><code>{{ access_number.access_number }}</code></h3>
              <p class="mb-0">
                <span class="badge bg-info">{{ access_number.semester }}</span>
                <span class="badge bg-secondary ms-1">{{ access_number.academic_year }}</span>
              </p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Quick Stats -->
      <div class="row mt-3">
        <div class="col-md-12">
          <div class="d-flex flex-wrap gap-3">
            <div class="px-3 py-2 bg-light rounded d-flex align-items-center">
              <i class="fas fa-book me-2 text-primary"></i>
              <div>
                <small class="text-muted">Total Units</small>
                <h5 class="mb-0">{{ course_units.count }}</h5>
              </div>
            </div>
            <div class="px-3 py-2 bg-light rounded d-flex align-items-center">
              <i class="fas fa-check-circle me-2 text-success"></i>
              <div>
                <small class="text-muted">Certified</small>
                <h5 class="mb-0">{{ course_units|length|default:0 }}</h5>
              </div>
            </div>
            <div class="px-3 py-2 bg-light rounded d-flex align-items-center">
              <i class="fas fa-user-tie me-2 text-info"></i>
              <div>
                <small class="text-muted">HOD Assigned</small>
                <h5 class="mb-0">{{ course_units|length|default:0 }}</h5>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show d-flex align-items-center" role="alert">
        {% if message.tags == 'success' %}
          <i class="fas fa-check-circle me-2"></i>
        {% elif message.tags == 'warning' %}
          <i class="fas fa-exclamation-triangle me-2"></i>
        {% elif message.tags == 'error' or message.tags == 'danger' %}
          <i class="fas fa-times-circle me-2"></i>
        {% else %}
          <i class="fas fa-info-circle me-2"></i>
        {% endif %}
        <div>{{ message }}</div>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4" id="courseUnitsTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="registered-tab" data-bs-toggle="tab" data-bs-target="#registered" type="button">
        <i class="fas fa-list-check me-1"></i> Registered Units ({{ course_units.count }})
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button">
        <i class="fas fa-plus-circle me-1"></i> Add New Units
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <a href="{% url 'pass_book:select_student' %}" class="nav-link">
        <i class="fas fa-users me-1"></i> Select Another Student
      </a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="courseUnitsTabContent">
    <!-- Registered Course Units Tab -->
    <div class="tab-pane fade show active" id="registered" role="tabpanel">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-list-check me-2"></i>Registered Course Units</h5>
          <div>
            <span class="badge bg-secondary">{{ course_units.count }}</span>
            {% if access_number.id %}
            <a href="{% url 'pass_book:student_course_units_list' access_number.id %}" class="btn btn-sm btn-light ms-2">
              <i class="fas fa-expand"></i> Full View
            </a>
            {% endif %}
          </div>
        </div>
        <div class="card-body p-0">
          {% if course_units %}
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-dark">
                  <tr>
                    <th width="12%">Code</th>
                    <th width="25%">Title</th>
                    <th width="10%">Status</th>
                    <th width="15%">HOD Name</th>
                    <th width="15%">Department</th>
                    <th width="8%">Certified</th>
                    <th width="15%" class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for cu in course_units %}
                    <tr>
                      <td>
                        <span class="badge bg-primary rounded-pill">{{ cu.course_unit.code }}</span>
                      </td>
                      <td>
                        <div class="fw-bold">{{ cu.course_unit.title }}</div>
                        <small class="text-muted">{{ cu.course_unit.course_code }}</small>
                      </td>
                      <td>
                        <span class="badge 
                          {% if cu.status == 'PASSED' %}bg-success
                          {% elif cu.status == 'RETAKE' %}bg-warning text-dark
                          {% elif cu.status == 'MISSED' %}bg-danger
                          {% else %}bg-secondary{% endif %}">
                          {{ cu.get_status_display }}
                        </span>
                      </td>
                      <td>
                        {% if cu.hod_name %}
                          <div class="d-flex align-items-center">
                            <i class="fas fa-user-tie text-info me-2"></i>
                            <span>{{ cu.hod_name }}</span>
                          </div>
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if cu.hod_department %}
                          <span class="badge bg-light text-dark">{{ cu.hod_department }}</span>
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>
                      <td class="text-center">
                        {% if cu.hod_certified %}
                          <i class="fas fa-check-circle text-success fs-5"></i>
                        {% else %}
                          <i class="fas fa-times-circle text-danger fs-5"></i>
                        {% endif %}
                      </td>
                      <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                          {% if cu.id %}
                          <a href="{% url 'pass_book:student_course_unit_update' cu.id %}" 
                             class="btn btn-outline-primary" 
                             title="Edit">
                            <i class="fas fa-edit"></i>
                          </a>
                          {% endif %}
                          <button type="button" class="btn btn-outline-info" title="View Details">
                            <i class="fas fa-eye"></i>
                          </button>
                          <button type="button" class="btn btn-outline-danger" title="Delete">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center text-muted py-5">
              <i class="fas fa-book-open display-1 opacity-25 mb-3"></i>
              <h4 class="mb-3">No Course Units Registered</h4>
              <p class="mb-4">Start by adding course units using the "Add New Units" tab.</p>
              <a href="#add" class="btn btn-primary" data-bs-toggle="tab">
                <i class="fas fa-plus-circle me-2"></i>Add Course Units
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Add New Course Units Tab -->
    <div class="tab-pane fade" id="add" role="tabpanel">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Bulk Add Course Units</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info d-flex align-items-center">
            <i class="fas fa-info-circle me-3 fs-4"></i>
            <div>
              <h6 class="alert-heading mb-1">Quick Add Instructions</h6>
              <p class="mb-0">Fill multiple course units at once.</p>
            </div>
          </div>

          <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
            {% csrf_token %}

            <div class="table-responsive">
              <table class="table table-bordered align-middle table-striped">
                <thead class="table-success">
                  <tr>
                    <th width="20%">Course Unit <span class="text-danger">*</span></th>
                    <th width="12%">Status</th>
                    <th width="10%">Certified?</th>
                    <th width="15%">HOD Name</th>
                    <th width="15%">Designation</th>
                    <th width="15%">Department</th>
                    <th width="8%">Date</th>
                    <th width="5%">Remove</th>
                  </tr>
                </thead>
                <tbody>
                  {{ formset.management_form }}
                  {% for form in formset %}
                    <tr class="form-row">
                      {% for field in form.visible_fields %}
                        <td>
                          {% if field.name == 'course_unit' %}
                            <div class="input-group input-group-sm">
                              <span class="input-group-text"><i class="fas fa-book"></i></span>
                              {{ field }}
                            </div>
                          {% elif field.name == 'status' %}
                            <div class="input-group input-group-sm">
                              <span class="input-group-text"><i class="fas fa-flag"></i></span>
                              {{ field }}
                            </div>
                          {% elif field.name == 'hod_certified' %}
                            <div class="form-check form-switch d-flex justify-content-center">
                              {{ field }}
                            </div>
                          {% elif field.name == 'DELETE' %}
                            <div class="form-check d-flex justify-content-center">
                              {{ field }}
                            </div>
                          {% else %}
                            <div class="input-group input-group-sm">
                              {% if field.name == 'hod_name' %}
                                <span class="input-group-text"><i class="fas fa-user-tie"></i></span>
                              {% elif field.name == 'hod_designation' %}
                                <span class="input-group-text"><i class="fas fa-briefcase"></i></span>
                              {% elif field.name == 'hod_department' %}
                                <span class="input-group-text"><i class="fas fa-building"></i></span>
                              {% elif field.name == 'hod_date' %}
                                <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                              {% endif %}
                              {{ field }}
                            </div>
                          {% endif %}
                          
                          {% if field.errors %}
                            <div class="text-danger small mt-1">
                              <i class="fas fa-exclamation-circle me-1"></i>
                              {{ field.errors|join:", " }}
                            </div>
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              
              {% if formset.forms %}
                {% with formset.forms.0 as first_form %}
                  {% if not first_form.course_unit.field.queryset and forloop.first %}
                    <div class="alert alert-warning mt-3">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      All available course units have already been registered.
                      {% if access_number.id %}
                      <a href="{% url 'pass_book:student_course_units_list' access_number.id %}" class="alert-link">View registered units</a>
                      {% endif %}
                      or remove some before adding new ones.
                    </div>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
              <div class="btn-group">
                <button type="submit" class="btn btn-success px-4">
                  <i class="fas fa-save me-2"></i> Save All Course Units
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="window.location.reload();">
                  <i class="fas fa-redo me-2"></i> Reset Form
                </button>
              </div>
              
              <div class="btn-group">
                <a href="{% url 'pass_book:select_student' %}" class="btn btn-outline-primary">
                  <i class="fas fa-users me-2"></i> Select Another Student
                </a>
                <a href="{% url 'pass_book:student_course_units' access_number.access_number %}" class="btn btn-outline-info">
                  <i class="fas fa-arrow-left me-2"></i> Back to Management
                </a>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Links Card (Only show if access_number.id exists) -->
  {% if access_number.id %}
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-light">
      <h6 class="mb-0"><i class="fas fa-link me-2"></i>Quick Navigation</h6>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <a href="{% url 'pass_book:select_student' %}" class="btn btn-outline-primary w-100 h-100">
            <i class="fas fa-users fa-2x mb-2"></i>
            <h6>Select Student</h6>
            <small class="text-muted">Choose different student</small>
          </a>
        </div>
        <div class="col-md-3">
          <a href="{% url 'pass_book:student_course_units_bulk' access_number.id %}" class="btn btn-outline-warning w-100 h-100">
            <i class="fas fa-layer-group fa-2x mb-2"></i>
            <h6>Bulk Add</h6>
            <small class="text-muted">Add multiple units</small>
          </a>
        </div>
        <div class="col-md-3">
          <a href="{% url 'pass_book:student_course_unit_add' access_number.id %}" class="btn btn-outline-success w-100 h-100">
            <i class="fas fa-plus-circle fa-2x mb-2"></i>
            <h6>Single Add</h6>
            <small class="text-muted">Add one unit</small>
          </a>
        </div>
        <div class="col-md-3">
          <a href="{% url 'pass_book:student_course_units_list' access_number.id %}" class="btn btn-outline-info w-100 h-100">
            <i class="fas fa-list fa-2x mb-2"></i>
            <h6>List View</h6>
            <small class="text-muted">Detailed list view</small>
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Tab Persistence
  const tabEl = document.querySelector('button[data-bs-target="#add"]');
  if (tabEl) {
    const tab = new bootstrap.Tab(tabEl);
    
    // Check if we should switch to add tab
    if (window.location.hash === '#add') {
      tab.show();
    }
  }
  
  // Prevent duplicate course unit selection
  const selects = document.querySelectorAll("select[name$='course_unit']");
  
  const updateOptions = () => {
    // Reset all options
    selects.forEach(s => {
      s.querySelectorAll("option").forEach(opt => {
        if (opt.value) opt.disabled = false;
      });
    });

    // Get selected values
    const selected = Array.from(selects)
      .map(s => s.value)
      .filter(v => v);

    // Disable already selected in others
    selects.forEach(s => {
      s.querySelectorAll("option").forEach(opt => {
        if (opt.value && selected.includes(opt.value) && opt.value !== s.value) {
          opt.disabled = true;
          if (s.value === opt.value) {
            opt.style.backgroundColor = '#e9ecef';
          }
        }
      });
    });
  };

  selects.forEach(s => s.addEventListener("change", updateOptions));
  updateOptions();
  
  // Form validation
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });
  
  // Auto-fill today's date for hod_date fields
  const dateFields = document.querySelectorAll('input[name$="hod_date"]');
  dateFields.forEach(field => {
    if (!field.value) {
      field.value = new Date().toISOString().split('T')[0];
    }
  });
});
</script>

<style>
.table th {
  font-weight: 600;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.table td {
  vertical-align: middle;
}

.form-row:hover {
  background-color: rgba(0, 123, 255, 0.05);
}

.input-group-sm .input-group-text {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.input-group-sm select,
.input-group-sm input {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.form-switch .form-check-input {
  width: 2.5em;
  height: 1.25em;
}

.nav-tabs .nav-link {
  font-weight: 500;
}

.nav-tabs .nav-link.active {
  font-weight: 600;
  border-bottom: 3px solid #0d6efd;
}

.card-header {
  border-bottom: none;
}

.badge {
  font-weight: 500;
}

.btn-group-sm > .btn {
  padding: 0.25rem 0.5rem;
}

.quick-links .btn {
  padding: 1.5rem 0.5rem;
  text-decoration: none;
  transition: all 0.3s ease;
}

.quick-links .btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

{% endblock %}